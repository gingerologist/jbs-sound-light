# Overview

本目录下文档视为剧本杀声光电系统中与设备有关部分的**软件详细设计**文档；原腾讯企业云盘内的文档视为需求，需求分析，系统分析和通讯协议参考设计文档。



## 硬件

| No     | 名称     | 交付类型 | 说明                                                         | 进度               |
| ------ | -------- | -------- | ------------------------------------------------------------ | ------------------ |
| H1-MP  | 智能灯泡 | 量产     | 使用`esp32-c3-mini-1`模块主控，5路pwm调光，rgb，冷白暖白，A60规格 | 未完成             |
| H1-DVT | 智能灯泡 | 设计验证 |                                                              | 未完成             |
| H1-EVT | 智能灯泡 | 工程验证 |                                                              | 已完成<br />未调试 |
| H2-MP  | 音箱网关 | 量产     | 包含`esp32-wrover-ie`和`esp32-c3-mini-1u`模块，dsp，功放，喇叭，按键，line-in；<br />wrover下载脚本，下载和存储音频，播放音频，向c3模块发送灯效指令；<br />c3与环境内的灯泡组网，发送灯效命令； | 未完成             |
| H2-DVT | 音箱网关 | 设计验证 |                                                              | 未完成             |
| H2-EVT | 音箱网关 | 工程验证 | PCB板完成，在备料贴片（11.10），未调试                       | 制作中             |
| H3-MP  | 完整包装 | 量产     | 路由器 x1<br />音箱网关 x1，具有唯一的二维码标识（打印，mac地址）<br />灯 x10，有组内编号（印刷标贴），二维码标识（喷码，mac地址）<br />贴在剧本杀房间内桌面上的二维码标识（打印）<br />其它包装内印刷品，填充物等 | 未完成             |
| D1     | C3开发板 | 工具     | 设计完成已经发板                                             | 制作中             |

说明：完整包装的操作流程很复杂，详见repack文档（尚无）；



## 软件

esp32的固件包含分区（partition），有两种分区类型，app和data。app类型的分区存放可执行程序，data类型的分区存放数据。

没有ota功能的固件可以仅有一个app分区，subtype是factory，bootloader直接启动factory分区的应用；有ota功能的固件可以没有factory分区，仅有ota_0, ota_1两个app分区和一个otadata分区，bootloader根据otadata决定启动ota_0或ota_1分区；bootloader同时支持test分区，test分区触发方式为gpio，可用于在制具上测试或其它量产功能需求，例如串口打印mac地址等设备信息。

以下列表中标注为factory的为不支持ota功能的固件；ota full指包含ota功能的完整固件；ota only指用于升级的固件，仅包含应用分区，无bootloader和data分区。



| No   | 名称                 | 类型     | 功能说明                                                     | 状态     |
| ---- | -------------------- | -------- | ------------------------------------------------------------ | -------- |
| C1   | C3/minimo            | factory  | 自定义协议的modem，用于音箱网关esp32-c3-mini-1u模块和开发    | 详细设计 |
| C2   | 灯最小量产固件       | ota full | 仅包含涂鸦产测和ota功能，无用户功能（见说明）                | 未开始   |
| C3   | 灯的功能固件         | factory  | 有协议和灯效无ota无产测，仅用于可线刷固件的开发板（D1）或官方开发板 | 详细设计 |
| C4   | 灯的完整功能固件     | ota full | C3 + ota                                                     | 未开始   |
| C5   | 灯的完整功能量产固件 | ota full | C4 + 涂鸦产测                                                | 未开始   |
| C6   | 灯的ota固件          | ota only | 未来迭代时生即用                                             | 未开始   |
| W1   | WROVER的功能固件     | factory  | 完成功能的测试固件                                           | ？？？   |
| W2   | WROVER的量产固件     | ota full | 产测、ota、和全部功能                                        | 未开始   |
| W3   | WROVER的ota固件      | ota only | 未来迭代时升级用                                             | n/a      |



说明：如果灯早期量产，选择C2固件量产，然后用C6升级；或者一直到C5完成量产；C4是最早可以用在H1-DVT上的固件，但不推荐这样做，尽量不要给工厂多个版本的量产固件，H1-DVT原则上应该使用C5固件，即完整功能的量产固件；或者使用C2，然后用C5中提取的ota_0升级。



## Mozart

Mozart是整个项目开发过程中的工具软件的codename。

| 功能集编号 | 必须/可选 | 说明                                                         | 状态   |
| ---------- | --------- | ------------------------------------------------------------ | ------ |
| 1          | 必须      | 访问usb串口的C3/minimo，调用所有指令，收取消息               | 未开始 |
| 2          | 必须      | 可侦听周围未组网的灯泡广播生成组网文件或使用预定义组网文件组网<br />在组网文件内编辑和包含灯效<br />向网络发送灯效观看效果<br />实现unibeacon协议所需的通讯协议<br />不包含固件升级，所有灯的固件预先线刷 | 未开始 |
| 3          | 必须      | 增加ota功能，从Mozart下发新固件版本至组内所有灯泡            | 未开始 |
| 4          | 可选      | 能本地模仿音箱网关的播放行为，直接打开本地文件播放           | 未开始 |
| 5          | 可选      | 能完整模仿音箱行为，包括和云通讯                             | 未开始 |
| 6          | 必须      | 模仿云服务协议向Gateway/Speaker下发configuration和音效灯效指令，模拟下载mp3文件 | 未开始 |
| 7          | 必须      | 支持完成组装业务                                             | 未开始 |



说明：

- 功能集1/2相当于PC/Mozart模仿了音箱里的C3模块，其中1是WROVER和C3通讯的部分，2是完成了组网协议；该功能对两个C3模块的开发是必须的工具；
- 功能集3对于客户端编辑人员是必要的，他们使用成品灯泡，如果要升级固件这是最好的方式（PC上需要有C3/minimo模块）；
- 功能集4是能做到整个播放体验，包括音乐/音效和灯光效果的最小系统，其中没有云和音箱网关，PC直接播放音乐并控制灯；
- 功能集5是音箱的mock，它比音箱更适合早期调试和云之间的通讯，利于快速确定设计和快速实现，实现后可以向音箱移植，该功能方便开发；
- 功能集6是模仿云，从开发工具的角度说不是必须，但它是功能7的功能子集，所以如果7必须，本功能也是必须；
- 功能集7是组装流程；



## 流程

### milestone 1

目标：C1的设计开发。

前置：C1的详细设计

开发环境搭建如图所示，通过PC/Mozart同时访问两个modem，每个modem可以是C3开发板（D1）或C3 DevkitM；

1. modem1发送蓝牙数据包，modem2接收；
2. modem1 wifi发送文件，可以直接连接pc的tcp端口；

```
     -------------> (modem1) 
     |                 |
     |                 |
[PC/Mozart]            |
     |                 |
     |                 v
     -------------> (modem2)
```

交付：

1. C1固件
2. Mozart的function set 1



### milestone 2

目标：C3的设计开发

前置：C1完成，Mozart的功能集1完成，unibeacon协议完成，组网配置文件格式设计完成，灯效数据格式设计完成；

开发环境搭建如图所示

1. 需要使用1块开发板使用minimo固件，模仿网关内的C3模块角色；
2. 需要有至少2块开发板调试协议；
3. 还可以增加更多的开发板充当多节点，以及使用单独的开发板和minimo固件侦听所有数据包发回PC；

```
     -------------> (minimo as group head) 
     |                 ^
     |                 |
[PC/Mozart]            |
     |                 |
     |                 v
     -------------> (bulb 1)
     |                 ^
     |                 |
     |                 |
     |                 v
     -------------> (bulb 2)
```

交付：

1. C3固件
2. Mozart的功能集2



### milestone 3

目标：C4/C5开发

前置：C3固件完成

开发环境搭建与milestone 2一致；

交付：

1. 支持OTA的C4固件
2. 增加涂鸦产测要求的C5固件
3. Mozart的功能集3



### milestone 4

目标：W1开发

前置：C1完成，至少C3完成，云接口通讯协议和下发命令的数据格式完成，WROVER模块的详细行为设计完成；

开发环境搭建如下图所示，是比较复杂的一个场景：

1. serial是下载和调试的接口；
2. gateway/speaker可以是音箱网关的EVT/DVT板，也可以是LyraT开发板；
3. PC通过千兆网口直连路由器的upstream wan口同时提供dhcp服务，这样PC可以用一个端口的tcp服务仿云；
4. bulb1/bulb2最好使用自制的C3开发板，有灯便于观察，有串口可以拉出来给PC观看收到的数据包的打印信息；

```
     --------------- serial -----------------
     |                                      |
     |                                      |
[PC/Mozart]-------> (router) <----> (gateway+speaker) 
     |                                      ^
     |                                      |
     ------1------> (bulb 1) <---------------
     |                 ^                    |
     |                 |                    |
     |                 v                    |
     ------2------> (bulb 2) <---------------
```

交付：

1. W1功能固件
2. Mozart的仿云功能



### milestone 5

目标：W2开发

其它：TBD



### milestone 6

目标：Mozart的功能集5









