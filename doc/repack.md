# Repack

Repack是在工业包装的灯和音箱齐备的情况下，组装最终产品的过程。



## 需求

1. 一个音箱和十个灯分为一组；
2. 音箱上标贴打印的二维码mac地址；
3. 灯上标贴打印的组内编号；
4. 灯上喷码mac地址；
5. 打印腾讯的小程序二维码；
6. 预加载mp3文件；
7. （可选）灯升级固件；
8. （可选）音箱升级固件；
9. 完成一次组网灯效测试；



## 流程

环境搭建如下图所示。有一个插座可以一排安装10个灯泡。电脑上安装Mozart软件，用Ethernet直连Wifi路由器的WAN口作为路由，提供DHCP服务，同时连接一个C3/minimo模块用于侦听灯泡的数据包（仅S1状态）。

```
(bulb)     (bulb)     (bulb)    (bulb) .... x10

                Ethernet
[PC/Mozart] ---------------> (wifi router) <----> (Gateway | Speaker)
      |
      ---------------------> (C3/minimo)
```

操作流程如下：

1. 选10个灯泡安装在插座上，打开电源；
2. Mozart软件通过C3/minimo模块听到10个（S1状态的）灯泡的广播，收集到所有灯泡的mac地址；
3. 在Mozart软件界面上操作把10个灯泡排成正确的顺序；
   1. 此步骤要求灯泡支持在S1状态下接收unicast消息（即消息内包含类型和目标节点的mac地址），并根据命令执行灯的状态变化，例如闪烁一下，此功能需加入灯泡的功能需求；
   2. 在灯支持1的前提下，Mozart软件界面可以直接触发灯的闪烁，可据此快速把灯按照顺序排成一行，界面上显示的从左至右和实物顺序一致；
4. 打开音箱网关，音箱网关会访问Mozart的服务。
   1. 服务的协议定义应与云一致。
   2. 音箱网关可以在通过IP网段+端口应答判定当前连接的是Mozart，不是真的云服务；这里最好使用显式设计而不是在PC上伪造DNS记录。该设计需要音箱在连接云的时候做一次判断，需加入音箱网关的功能需求；
5. Mozart获得音箱网关的mac地址和固件版本，首先判定是否需要推送升级固件；如果需要推送升级固件，Mozart返回给音箱升级固件的要求和固件所在地址；音箱网关开始自动升级，升级后重启设备重新连接Mozart；
6. Mozart使用音箱网关的mac地址和10个灯泡mac地址即时生成一个组网文件下发给Mozart开始组网；
7. 音箱网关根据下发的组网文件准备资源，包括：
   1. mp3文件资源
   2. 灯泡的固件
8. 音箱网关在准备好灯泡的固件之后即可向所有灯泡发送组网文件；
9. 灯泡组网有一个过程，其中包括必要的固件升级步骤，最终音箱网关和C3/minimo都可获知所有灯泡进入S3状态；
10. 播放一次灯效，再次确认灯泡的编号顺序和物理摆放顺序一致；
11. 至此所有获取组网数据，资源下载，固件升级，和测试工作都完成；操作人员可以：
    1. 向云提交组网记录（mac地址）
    2. 给灯泡喷码，贴标
    3. 打印音箱的二维码粘贴
    4. 打印小程序二维码
    5. 完成其它包装业务需求



问题：

1. 下载mp3会很慢