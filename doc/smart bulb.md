# Smart Bulb

灯泡内包含一个`esp32-c3-mini-1`模块，使用高温和4MB flash版本（H4），通过五路GPIO输出PWM信号控制灯。



和音箱网关类似，灯泡实现BLE的广播包收发，wifi的sta模式发送数据，和softap模式接收数据。这些通讯过程用于实现即时组网，接收和**转发**灯效命令，固件升级等业务。通讯协议的详细设计参见unibeacon文档。



无论是产品开发阶段，再包装流程，还是用户处部署，灯泡的工作模式都是在C3/minimo模块的发起下即时形成组（Instant Grouping），如下图所示。注意通讯中既有可能出现单向通讯（例如bulb a能听到bulb b广播，但bulb b无法听到bulb a的），也有可能出现无法与C3/minimo直接通讯的节点（bulb d），unibeacon协议支持灯效命令的一次跳越，即bulb c将转发C3/minimo的灯效命令，覆盖bulb d。

```
      ----------> (bulb a)
      |               ^
      |               |
      v               |
(C3/minimo) <---> (bulb b)
      ^               ^
      |               |
      |               v
      ----------> (bulb c) <----> (bulb d)
```



Instant Grouping设计的意思是灯并不记录自己的分组信息，由附近的C3/minimo模块或者同组其它灯节点负责投递该信息给自己。



在灯刚刚上电尚未获得该信息时，灯进入第一个状态S1，在S1状态下，灯广播自己的mac地址，打开wifi soft-ap模式，使用预定义格式的ssid（含mac）和密码（含mac）。



灯获得分组信息文件后，检查分组信息内的要求，确定自己的固件版本满足分组信息要求则进入S3状态，S3是工作状态；如果固件不满足要求，灯进入S2状态请求固件并完成自动升级，自动升级后重启回到S1状态，即不会有S2 -> S1的迁移。



无论在何种状态下，一个节点都会广播自己的Neighbor List，列表中包含Neighbor的状态（S1, S2, S3），这样C3/minimo可以获知附近的组成员是否都已经达到S3状态，以开始灯效播放。



如果在播放过程中C3/minimo退出，包括意外断电的退出，它可以使用蓝牙命令通知所有附近节点，导致这些节点重启，S3->S1迁移；如果C3/minimo无法say goodbye，则所有节点只能通过组网的Depth阈值（Depth指距离Group Head的距离）来判定。



存在可能性当C3/minimo上电时，发现附近组成员已经组网（例如C3/minimo短暂的意外断电），这种情况可能需要特殊指令强制所有节点重启（TBD）。



## 需求

1. 量产固件支持涂鸦测试
2. 量产和ota固件均支持ota升级
3. boot ota功能可选实现，boot ota指在bootloader内实现的ota，保证设备永远可以强刷固件
4. 实现Unibeacon组网协议
5. 实现灯效控制
6. 组装业务支持（在S1状态下支持蓝牙指令）

